---
title: On-upload Malware Scanning in Microsoft Defender for Storage
description: Discover how on-upload malware scanning enhances security in Microsoft Defender for Storage.
ms.date: 10/13/2024
author: dcurwin
ms.author: dacurwin
ms.topic: how-to
---

# On-upload malware scanning

On-Upload Malware Scanning in Microsoft Defender for Storage automatically scans blobs when they're uploaded or modified, providing near real-time detection against malicious content. This cloud-native, SaaS-based solution uses Microsoft Defender Antivirus to perform comprehensive malware scans, ensuring your storage accounts remain secure without the need for extra infrastructure or maintenance.

By integrating on-upload scanning into your storage accounts, you can:

- **Prevent malicious uploads:** Stop malware from entering your storage environment at the point of upload.
- **Simplify security management:** Benefit from automatic scanning without deploying or managing agents.
- **Enhance compliance:** Meet regulatory requirements by ensuring all uploaded data is scanned for malware.

Malware upload is a top threat for cloud storage, as malicious files can enter and spread within an organization through cloud storage services. Microsoft Defender for Storage provides a built-in solution to mitigate this risk with comprehensive anti-malware capabilities.

:::image type="content" source="media/defender-for-storage-malware-scan/malware-scan-in-defender-for-storage.png" alt-text="Diagram showing how malware scanning protects your data from malicious code." lightbox="media/defender-for-storage-malware-scan/malware-scan-in-defender-for-storage.png":::

## Common use cases

- **Web applications:** Secure user-generated content uploads in web applications such as tax apps, CV upload sites, and receipt uploads.
- **Content distribution:** Protect assets like images and videos shared at scale through content hubs or CDNs (Content Delivery Networks), which can be common malware distribution points.
- **Compliance requirements:** Meet regulatory standards, such as [NIST](defender-for-cloud-glossary.md#nist), SWIFT, and GDPR, by scanning untrusted content, especially for regulated industries.
- **Third-party integration:** Ensure third-party data, such as content from business partners or contractors, is scanned to prevent security risks.
- **Collaborative platforms:** Ensure safe collaboration across teams and organizations by scanning shared content.
- **Data pipelines:** Maintain data integrity in ETL (Extract, Transform, Load) processes by ensuring no malware enters through multiple data sources.
- **Machine learning training data:** Protect the quality of training data by ensuring data sets are clean and safe, particularly if they contain user-generated content.

    :::image type="content" source="media/defender-for-storage-malware-scan/malware-scan-tax-app-demo.gif" alt-text="animated GIF showing user-generated-content and data from external sources." lightbox="media/defender-for-storage-malware-scan/malware-scan-tax-app-demo.gif":::

> [!NOTE]
> Malware scanning is a near real-time service. Scan times can vary depending on file size, file type, service load, and storage account activity.

## Enabling on-upload malware scanning

### Prerequisites

- **Permissions:** Owner or Contributor role on the subscription or storage account, or specific roles with the [necessary permissions](support-matrix-defender-for-storage.md).
- **Defender for Storage:** Must be enabled on the subscription or individual storage accounts.

To [enable and configure Malware Scanning](tutorial-enable-storage-plan.md) across your subscriptions while retaining detailed control over individual storage accounts, you can use one of the following methods:

1. [Azure built-in policy](defender-for-storage-policy-enablement.md)
1. Programmatically using Infrastructure as Code templates, including [Terraform](defender-for-storage-infrastructure-as-code-enablement.md?tabs=enable-subscription#terraform-template), [Bicep](defender-for-storage-infrastructure-as-code-enablement.md?tabs=enable-subscription&branch=pr-en-us-248836#bicep-template), and [ARM](defender-for-storage-infrastructure-as-code-enablement.md?tabs=enable-subscription#azure-resource-manager-template) templates
1. Using the [Azure portal](defender-for-storage-azure-portal-enablement.md?tabs=enable-subscription)
1. Using PowerShell
1. Directly with the [REST API](defender-for-storage-rest-api-enablement.md?tabs=enable-subscription)

When malware scanning is enabled, an Event Grid System Topic resource is automatically created in the same resource group as the storage account. This is used by the malware scanning service to listen to blob upload triggers.

For detailed instructions, see [Deploy Microsoft Defender for Storage](tutorial-enable-storage-plan.md).

## Cost control

Malware scanning is billed per GB scanned. To provide cost predictability, Malware Scanning supports setting a cap on the amount of GB scanned in a single month per storage account.

> [!IMPORTANT]
> Malware scanning in Defender for Storage is not included in the first 30-day trial for free and will be charged from the first day in accordance with the pricing scheme available on the Defender for Cloud [pricing page](https://azure.microsoft.com/pricing/details/defender-for-cloud/).

The [capping mechanism](tutorial-enable-storage-plan.md#set-up-and-configure-microsoft-defender-for-storage) sets a monthly scanning limit, measured in gigabytes (GB), for each storage account. This serves as an effective cost control measure. If a predefined scanning limit is reached for a storage account within a single calendar month, the scanning operation automatically halts. This halt occurs once the threshold is reached, with up to a 20-GB deviation. Files won't be scanned for malware beyond this point. The cap resets at the end of every month at midnight UTC. Updating the cap typically takes up to an hour to take effect.

By default, a limit of 5 TB (5,000 GB) is established if no specific capping mechanism is defined.

> [!TIP]
> You can set the capping mechanism on either individual storage accounts or across an entire subscription (every storage account on the subscription will be allocated the limit defined on the subscription level).

### Additional costs

Azure Services: Malware scanning uses other Azure services, which might incur additional costs:

- Azure Storage read operations
- Azure Storage blob indexing
- Azure Event Grid notifications

#### Blob uploads and index tag updates

When a blob is uploaded to the storage account, malware scanning initiates an extra read operation and updates the index tag. In most cases, these operations don't generate significant load.

## How malware scanning works

### On-upload malware scanning flow

On-upload scans are triggered by any operation that results in a `BlobCreated` event, as specified in the [Azure Blob Storage as an Event Grid source](/azure/event-grid/event-schema-blob-storage) documentation. These operations include:

- **Uploading new blobs:** When a new blob is added to a container
- **Overwriting existing blobs:** When an existing blob is replaced with new content
- **Finalizing changes to blobs:** Operations like `PutBlockList` or `FlushWithClose` that commit changes to a blob

> [!NOTE]
> Incremental operations such as `AppendFile` in Azure Data Lake Storage Gen2 and `PutBlock` in Azure BlockBlob do not trigger a malware scan on their own. A malware scan is initiated only when these additions are officially committed (e.g., `PutBlockList` or `FlushWithClose`).

### Scanning process

1. **Event detection:** When a `BlobCreated` event occurs, the malware scanning service detects the change.
1. **Blob retrieval:** The service securely reads the blob content within the same region as your storage account.
1. **In-memory scanning:** The content is scanned in-memory using Microsoft Defender Antivirus with up-to-date malware definitions.
1. **Result generation:** The scan result is generated, and appropriate actions are taken based on the findings.
1. **Content disposal:** Scanned content isn't retained and is deleted immediately after scanning.

### Response automation

Malware Scanning supports automated responses at scale, such as deleting or quarantining suspicious files. This can be managed using blobs' index tags or by setting up Event Grid events for automation purposes.

## Viewing and consuming scan results

### Scan results methods

After setup, scan results are available through several methods:

1. [Blob index tags](/azure/storage/blobs/storage-blob-index-how-to): Metadata fields on a blob, indicating malware scanning results and scan time. These tags are automatically indexed but aren't tamper-resistant.
1. **Defender for Cloud security alerts:** When a malicious file is detected, [security alerts](alerts-overview.md#what-are-security-alerts) are generated in Microsoft Defender for Cloud with details on the file, malware type, and remediation steps.
1. **Event Grid events:** Provides event-driven automation with low latency, suitable for automating response workflows.
1. **Log Analytics workspace:** Store scan results for compliance and investigation purposes. Logs can be viewed in the Log Analytics destination workspace under the `StorageMalwareScanningResults` table.

## Supported content and limitations

### Supported content

- **File types:** All file types, including archives like ZIP files.
- **File size:** Blobs up to 2 GB in size.

### Limitations

- **Unsupported storage accounts:** Legacy v1 storage accounts aren't supported.
- **Unsupported blob types:** [Append blobs and page blobs](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs) aren't supported.
- **Unsupported encryption:** Client-side encrypted blobs can't be scanned, as they can't be decrypted by the service. Blobs encrypted at rest with Customer Managed Keys (CMK) are supported.
- **Unsupported protocols:** Blobs uploaded via the Network File System (NFS) 3.0 protocol aren't scanned.
- **Blob index tags:** Index tags aren't supported for storage accounts with hierarchical namespace enabled (Azure Data Lake Storage Gen2).
- **Unsupported regions:** Certain regions aren't supported for malware scanning. Learn more about [availability for Defender for Storage.](defender-for-storage-introduction.md)
- **Chunked data:** Malware scanning doesn't effectively detect malware in blobs that contain chunked data, for example, files split into smaller parts. This issue is common in backup services that upload backup data in chunks to storage accounts. The scanning process might miss malicious content or incorrectly flag clean content, leading to false negatives and false positives. To mitigate this risk, consider implementing further security measures, such as scanning data before it's chunked or after it's fully reassembled.
- **Impact on access:** Access to blobs remains unaffected during scanning, and the impact on storage Input/Output Operations Per Second (IOPS) is minimal.

## Throughput and capacity

- **Scan throughput rate limit:** Malware Scanning can process up to 2 GB per minute for each storage account. If the rate of file upload momentarily exceeds this threshold for a storage account, the system attempts to scan the files in excess of the rate limit. If the rate of file upload consistently exceeds this threshold, some blobs won't be scanned.
- **Blob scan limit:** Malware Scanning can process up to 2,000 files per minute for each storage account. If the rate of file upload momentarily exceeds this threshold for a storage account, the system attempts to scan the files in excess of the rate limit. If the rate of file upload consistently exceeds this threshold, some blobs won't be scanned.

### Limitations compared to Microsoft Defender for Endpoint

Defender for Storage utilizes the same antimalware engine and up-to-date signatures as Defender for Endpoint to scan for malware. However, when files are uploaded to Azure Storage, they lack certain metadata that the antimalware engine depends on. This lack of metadata can lead to a higher rate of missed detections, known as 'false negatives,' in Azure Storage compared to those detected by Defender for Endpoint.

The following are some examples of missing metadata:

- **Mark of the Web (MOTW):** MOTW is a Windows security feature that tracks files downloaded from the internet. However, when files are uploaded to Azure Storage, this metadata isn't preserved.
- **File path context:** On standard operating systems, the file path can provide more context for threat detection. For example, a file trying to modify system locations (for example, `C:\Windows\System32`) would be flagged as suspicious and be subject to further analysis. In Azure Storage, the context of specific file paths within the blob can't be utilized in the same way.
- **Behavioral data:** Defender for Storage analyzes the contents of files without running them. It inspects the files and might emulate their execution to check for malware. However, this approach might not detect certain types of malware that reveal their malicious nature only during execution.

## Access and data privacy

### Data access requirements

The Malware Scanning service requires access to your data to scan for malware. During service enablement, a new Data Scanner resource called `StorageDataScanner` is created in your Azure subscription. This resource is assigned a system-assigned managed identity and given the Storage Blob Data Owner role assignment to access and scan your data.

If your storage account networking configuration is set to Enable Public network access from selected virtual networks and IP addresses, the `StorageDataScanner` resource is added to the Resource instances section under the storage account networking configuration to allow scanning access.

### Data privacy and regional processing

- **Regional processing:** Scanning occurs within the same Azure region as your storage account to comply with data residency requirements.
- **Data handling:** Scanned files aren't stored. In some cases, file metadata (for example, SHA-256 hash) might be shared with Microsoft Defender for Endpoint for further analysis.
- **Private endpoint support:** Malware scanning supports [Private endpoints](/azure/storage/common/storage-private-endpoints), ensuring data privacy by eliminating public internet exposure.

## Handling possible false positives and false negatives

### False positives

False positives occur when the system incorrectly identifies a benign file as malicious. To address these:

1. **Submit for analysis**
   - Use the [Sample Submission Portal](https://www.microsoft.com/wdsi/filesubmission) to report false positives.
   - Select "Microsoft Defender for Storage" as the source when submitting.

2. **Suppress alerts**
   - [Create suppression rules](alerts-suppression-rules.md) in Defender for Cloud to prevent specific recurring false positive alerts.

### False negatives

False negatives happen when the system fails to detect an actually malicious file. If you suspect this has occurred:

### Report undetected malware

- If you believe a file is malicious but wasn't flagged by the system, submit it for analysis through the same [Sample Submission Portal](https://www.microsoft.com/wdsi/filesubmission).
- Provide as much context as possible about why you suspect the file to be malicious.

> [!NOTE]
> Regularly reporting false positives and negatives helps improve the accuracy of the malware detection system over time.

## Setup tips and best practices

- Ensure all relevant permissions are granted to prevent issues with enabling malware scanning.
- Regularly review the configuration of resources like `StorageDataScanner` and Event Grid System Topics to ensure malware scanning continues to function properly.
- Use Log Analytics to track scan history for compliance and auditing purposes.

> [!TIP]
> We encourage you to explore the Malware Scanning feature in Defender for Storage through our hands-on lab. Follow the [Ninja training](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Modules/Module%2019%20-%20Defender%20for%20Storage.md) instructions for a detailed guide on setup, testing, and response configuration.

## Related content

- [Introduction to malware scanning](introduction-malware-scanning.md)
- [On-demand malware scanning](on-demand-malware-scanning.md)
