---
title: Gated deployment for Infrastructure as Code
description: Learn how to deploy gated deployment infrastructure as code for managed cluster API.
#customer intent: As a Kubernetes administrator, I want to deploy gated deployment infrastructure as code so that I can automate the setup and ensure consistent configuration across environments.
author: Elazark
ms.author: elkrieger
ms.date: 02/16/2026
ms.topic: how-to
---

# Gated deployment for Infrastructure as Code

Microsoft Defender for Cloud's gated deployment agent is a Kubernetes admission controller that enforces container image security policies at deployment time. Gated deployment acts as a gatekeeper for container images for known security problems at deployment time and decides whether they're allowed to run.

The gated deployment agent requires read access to all of your Azure Container Registries (ACRs) associated with the cluster. These registries store the container images alongside the vulnerability assessment artifacts generated by Defender for Containers. To enable this access, configure a Managed Service Identity (MSI) with the required ACR read permissions and assign it to the agent.

## Prerequisites

- An Azure subscription with Microsoft Defender for Cloud enabled.
- You must [enable gated deployment in Defender for Containers](enablement-guide-runtime-gated.md) with the defender sensor and registry access extensions turned on.
- The Azure Kubernetes Service (AKS) cluster must have an OpenID Connect (OIDC) issuer enabled and an Azure Workload Identity enabled.

## Deploy the gated agent

1. [Create a Managed Service Identity (MSI) that the gated deployment agent uses](/entra/identity/managed-identities-azure-resources/manage-user-assigned-managed-identities-azure-portal).

1. [Assign the AcrPull role (or equivalent read role)](/azure/container-registry/container-registry-rbac-built-in-roles-overview?tabs=registries-configured-with-rbac-registry-abac-repository-permissions) to the MSI on all ACRs the cluster uses.

1. [Add a Federated Identity Credential (FIC) to the MSI](/graph/api/resources/federatedidentitycredentials-overview?view=graph-rest-1.0) that allows the gated deployment agent to authenticate by using AKS Workload Identity, with the following FIC parameters:

    - **Issuer**: The AKS OIDC issuer URL
    - **Subject**: The service account used by the gated deployment agent `system:serviceaccount:kube-system:defender-admission-controller-serviceaccount`.
    - **Audience**: api://AzureADTokenExchange

1. Set the MSIâ€™s objectId in the identities parameter under the security gating section of the managed cluster API configuration. This ensures the gated deployment agent can use the MSI at runtime.

## Next step

> [!div class="nextstep"]
> [Troubleshoot gated deployment in Kubernetes](troubleshooting-runtime-gated.md)
